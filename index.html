<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SmartSwitch </title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’¡</text></svg>">
<style>
:root{
  --bg: linear-gradient(180deg,#0f1030 0%, #0b1538 100%);
  --card: rgba(255,255,255,0.03);
  --glass: rgba(255,255,255,0.09);
  --accent1: #7fb1ff;
  --accent2: #9a6bff;
  --muted: rgba(255,255,255,0.96);
  --muted2: rgba(255,255,255,0.55);
  --nav-height:92px;
  --max-width:980px;
  --soft-shadow: 0 10px 30px rgba(13,18,46,0.55);
  --blur: 8px;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:none}
html,body{height:100%;margin:0;background:var(--bg);color:var(--muted);font-family:Inter,system-ui,Roboto,Arial}
body{padding:0;margin:0}
#main{max-width:var(--max-width);margin:14px auto;padding:12px;padding-bottom:calc(var(--nav-height) + 32px)}

/* Header */
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
.brand{display:flex;align-items:center;gap:12px}
.mark{width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;overflow:hidden;box-shadow:0 8px 30px rgba(122,57,255,0.06)}
.mark img{width:100%;height:100%;object-fit:cover}
.brand-title{font-size:18px;font-weight:700}
.brand-sub{font-size:12px;color:var(--muted2)}

/* WiFi round icon */
.wifi-btn{width:48px;height:48px;border-radius:12px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:center;position:relative;cursor:pointer;transition:all .18s}
.wifi-btn.connected{background:linear-gradient(135deg,#b7f7d4,#7df2a3);box-shadow:0 12px 32px rgba(125,242,163,0.12)}
.wifi-btn.disconnected{background:linear-gradient(135deg,#ff9a9a,#ff5c5c);box-shadow:0 12px 32px rgba(255,92,92,0.12)}
.wifi-arc{position:absolute;border-radius:50%;border-top:3px solid rgba(255,255,255,0.95);border-left:3px solid transparent;border-right:3px solid transparent;border-bottom:3px solid transparent;opacity:0.95;animation: wifiPulse 2s infinite ease-in-out}
.wifi-arc:nth-child(2) { animation-delay: 0.2s; }
.wifi-arc:nth-child(3) { animation-delay: 0.4s; }
.wifi-a1{width:14px;height:14px;bottom:8px}
.wifi-a2{width:24px;height:24px;bottom:3px}
.wifi-a3{width:34px;height:34px;bottom:-3px}
.wifi-dot{width:7px;height:7px;background:white;border-radius:50%;position:absolute;bottom:15px}
.wifi-btn.connected .wifi-arc, .wifi-btn.connected .wifi-dot{animation:pulse 1.8s infinite ease-in-out}
@keyframes pulse{0%{opacity:1;transform:scale(1)}50%{opacity:.78;transform:scale(1.04)}100%{opacity:1;transform:scale(1)}}

/* Instagram-like Logo Animation */
@keyframes logoEntrance {
  0% {
    transform: scale(0.2);
    opacity: 0;
  }
  50% {
    transform: scale(1.1);
    opacity: 1;
  }
  70% {
    transform: scale(0.9);
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}

@keyframes wavePulse {
  0% {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
  }
  100% {
    transform: translate(-50%, -50%) scale(1.5);
    opacity: 0;
  }
}

@keyframes buttonPulse {
  0% {
    transform: scale(1);
    box-shadow: 0 8px 30px rgba(0,0,0,0.6);
  }
  50% {
    transform: scale(1.05);
    box-shadow: 0 12px 40px rgba(0,0,0,0.8);
  }
  100% {
    transform: scale(1);
    box-shadow: 0 8px 30px rgba(0,0,0,0.6);
  }
}

@keyframes bulbGlow {
  0% {
    transform: scale(1);
    filter: brightness(1);
  }
  50% {
    transform: scale(1.05);
    filter: brightness(1.2);
  }
  100% {
    transform: scale(1);
    filter: brightness(1);
  }
}

@keyframes wifiPulse {
  0% {
    opacity: 0.6;
    transform: scale(0.95);
  }
  50% {
    opacity: 1;
    transform: scale(1.05);
  }
  100% {
    opacity: 0.6;
    transform: scale(0.95);
  }
}

/* CSS Logo */
.mark-css {
  width: 52px;
  height: 52px;
  border-radius: 16px;
  background: linear-gradient(135deg, var(--accent1), var(--accent2));
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  box-shadow: 0 8px 30px rgba(122,57,255,0.15);
  position: relative;
  animation: logoEntrance 1.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
  opacity: 0;
}

.logo-icon {
  position: relative;
  width: 32px;
  height: 32px;
}

.logo-circle {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  border: 2px solid white;
  animation: logoEntrance 1.2s 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
  opacity: 0;
}

.logo-inner {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: white;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  opacity: 0;
  animation: logoEntrance 1.2s 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

.logo-wave {
  position: absolute;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: 2px solid rgba(255, 255, 255, 0.7);
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  animation: wavePulse 2s infinite ease-out;
  opacity: 0;
  animation-delay: 0.6s;
  animation-fill-mode: forwards;
}

.logo-wave:nth-child(2) {
  animation-delay: 0.9s;
}

.logo-wave:nth-child(3) {
  animation-delay: 1.2s;
}

/* Cards */
.card{background:linear-gradient(180deg, rgba(255,255,255,0.014), rgba(255,255,255,0.008));border-radius:14px;padding:12px;border:1px solid var(--glass);backdrop-filter: blur(var(--blur));box-shadow:var(--soft-shadow);margin-bottom:12px}
.status-row{display:flex;justify-content:space-between;align-items:center;gap:10px}
.pres-left{display:flex;align-items:center;gap:8px}
.pres-dot{width:12px;height:12px;border-radius:50%;background:#2a2a42}
.pres-dot.on{background:#4ef0a0;box-shadow:0 6px 18px rgba(78,240,160,0.08)}
.small{font-size:13px;color:var(--muted2)}

/* Lights grid fixed 3-in-row */
.lights-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:12px;align-items:start}
.light-block{text-align:center;cursor:pointer}
.circle{width:86px;height:86px;border-radius:999px;margin:0 auto;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.06);transition:all .16s}
.circle:active{transform:translateY(-3px) scale(.98)}
.bulb{font-size:36px;transition:all .22s;animation: bulbGlow 3s infinite ease-in-out}
.inner-status{font-size:12px;font-weight:700;color:var(--muted2)}
.light-block.on .circle{background:linear-gradient(135deg,#fff2c2,#ffd17a);border:1px solid rgba(255,255,255,0.16);box-shadow:0 16px 60px rgba(255,200,100,0.12)}
.light-block.on .bulb{transform:scale(1.12);filter:brightness(1.55) saturate(1.4);text-shadow:0 8px 22px rgba(255,190,60,0.12);animation: bulbGlow 1.5s infinite ease-in-out}
.nameBelow{margin-top:8px;font-weight:600;color:var(--muted)}

/* last row center two */
.last-row{grid-column:1 / -1;display:flex;justify-content:space-around;gap:18px;padding-top:6px}

/* Modes top */
.modes-row{display:flex;gap:10px;margin-top:12px}
.mode{flex:1;padding:10px;border-radius:12px;background:rgba(255,255,255,0.02);text-align:center;cursor:pointer;transition:all .14s}
.mode:hover{transform:translateY(-4px)}
.mode.active{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#07213a;box-shadow:0 12px 30px rgba(122,57,255,0.08);font-weight:700}
.setup-btn{padding:8px 12px;border-radius:10px;background:linear-gradient(90deg,var(--accent1),var(--accent2));border:0;color:#07213a;cursor:pointer;font-weight:700;box-shadow:0 8px 30px rgba(125,150,255,0.06)}

/* bottom navbar */
#navbar{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;width:94%;max-width:var(--max-width);z-index:9999}
.bottom-nav{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:999px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);width:100%;box-shadow:0 8px 30px rgba(0,0,0,0.6);height:var(--nav-height);backdrop-filter: blur(12px);-webkit-backdrop-filter: blur(12px);}
.nav-item{flex:1;text-align:center;padding:6px 6px;border-radius:12px;color:var(--muted2);cursor:pointer;transition:all .14s}
.nav-item.active{color:#07213a;background:linear-gradient(90deg,var(--accent1),var(--accent2));box-shadow:0 12px 30px rgba(125,150,255,0.10)}

/* icons simple shapes */
.home-icon{width:22px;height:22px;display:block;margin:0 auto;position:relative}
.home-icon:before{content:"";position:absolute;left:50%;top:0;transform:translateX(-50%);width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-bottom:12px solid rgba(255,255,255,0.95)}
.home-icon:after{content:"";position:absolute;left:50%;top:10px;transform:translateX(-50%);width:18px;height:12px;border:3px solid rgba(255,255,255,0.95);border-top:none;border-radius:3px}
.clock-icon{width:20px;height:20px;margin:0 auto;border:3px solid rgba(255,255,255,0.95);border-radius:50%;position:relative}
.clock-icon:after{content:"";position:absolute;left:50%;top:40%;transform:translate(-50%,-50%);width:2px;height:6px;background:rgba(255,255,255,0.95)}
.gear-icon{width:18px;height:18px;margin:0 auto;position:relative}
.gear-ring{width:10px;height:10px;border:3px solid rgba(255,255,255,0.95);border-radius:50%;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:2}
.gear-tooth{position:absolute;width:4px;height:10px;background:rgba(255,255,255,0.95);border-radius:3px;left:50%;top:50%;transform-origin:center -6px}
.gear-tooth.t1{transform:translate(-50%,-50%) rotate(0deg)}.gear-tooth.t2{transform:translate(-50%,-50%) rotate(45deg)}.gear-tooth.t3{transform:translate(-50%,-50%) rotate(90deg)}.gear-tooth.t4{transform:translate(-50%,-50%) rotate(135deg)}.gear-tooth.t5{transform:translate(-50%,-50%) rotate(180deg)}.gear-tooth.t6{transform:translate(-50%,-50%) rotate(225deg)}.gear-tooth.t7{transform:translate(-50%,-50%) rotate(270deg)}.gear-tooth.t8{transform:translate(-50%,-50%) rotate(315deg)}

/* Modern Tab Icons */
.home-icon-modern {
  width: 24px;
  height: 24px;
  position: relative;
  margin: 0 auto;
}

.home-icon-modern:before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 0;
  height: 0;
  border-left: 12px solid transparent;
  border-right: 12px solid transparent;
  border-bottom: 10px solid rgba(255,255,255,0.95);
}

.home-icon-modern:after {
  content: "";
  position: absolute;
  top: 10px;
  left: 4px;
  width: 16px;
  height: 12px;
  background: rgba(255,255,255,0.95);
  border-radius: 2px;
}

.clock-icon-modern {
  width: 22px;
  height: 22px;
  margin: 0 auto;
  border: 2px solid rgba(255,255,255,0.95);
  border-radius: 50%;
  position: relative;
}

.clock-icon-modern:before {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  width: 2px;
  height: 6px;
  background: rgba(255,255,255,0.95);
  transform: translate(-50%, -50%);
}

.clock-icon-modern:after {
  content: "";
  position: absolute;
  top: 30%;
  left: 50%;
  width: 6px;
  height: 2px;
  background: rgba(255,255,255,0.95);
  transform: translate(-50%, -50%);
}

.gear-icon-modern {
  width: 24px;
  height: 24px;
  margin: 0 auto;
  position: relative;
}

.gear-icon-modern::before {
  content: '';
  position: absolute;
  width: 20px;
  height: 20px;
  border: 2px solid rgba(255,255,255,0.95);
  border-radius: 50%;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
}

.gear-icon-modern::after {
  content: '';
  position: absolute;
  width: 10px;
  height: 10px;
  border: 2px solid rgba(255,255,255,0.95);
  border-radius: 50%;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
}

.gear-icon-modern .gear-tooth {
  position: absolute;
  width: 3px;
  height: 6px;
  background: rgba(255,255,255,0.95);
  left: 50%;
  top: -3px;
  transform-origin: center 15px;
}

.gear-icon-modern .gear-tooth.t1 { transform: translate(-50%, -50%) rotate(0deg); }
.gear-icon-modern .gear-tooth.t2 { transform: translate(-50%, -50%) rotate(30deg); }
.gear-icon-modern .gear-tooth.t3 { transform: translate(-50%, -50%) rotate(60deg); }
.gear-icon-modern .gear-tooth.t4 { transform: translate(-50%, -50%) rotate(90deg); }
.gear-icon-modern .gear-tooth.t5 { transform: translate(-50%, -50%) rotate(120deg); }
.gear-icon-modern .gear-tooth.t6 { transform: translate(-50%, -50%) rotate(150deg); }
.gear-icon-modern .gear-tooth.t7 { transform: translate(-50%, -50%) rotate(180deg); }
.gear-icon-modern .gear-tooth.t8 { transform: translate(-50%, -50%) rotate(210deg); }
.gear-icon-modern .gear-tooth.t9 { transform: translate(-50%, -50%) rotate(240deg); }
.gear-icon-modern .gear-tooth.t10 { transform: translate(-50%, -50%) rotate(270deg); }
.gear-icon-modern .gear-tooth.t11 { transform: translate(-50%, -50%) rotate(300deg); }
.gear-icon-modern .gear-tooth.t12 { transform: translate(-50%, -50%) rotate(330deg); }

/* Centered modal styling + blur behind */
.modal-back{position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:1200}
.modal{width:92%;max-width:520px;background:linear-gradient(180deg,#0f0720,#150926);border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.06);box-shadow:0 30px 80px rgba(0,0,0,0.6);backdrop-filter: blur(6px);}

/* mode choices grid */
.mode-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.mode-chip{padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);cursor:pointer;text-align:center;color:var(--muted2);border:1px solid rgba(255,255,255,0.03)}
.mode-chip.selected{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#07213a}

/* Connected mode states */
.mode-chip.connected{background:linear-gradient(135deg, #4ef0a0, #2ed18a); color: #07213a; box-shadow: 0 0 15px rgba(78, 240, 160, 0.3);}


.mode-chip:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

.mode-chip.selected {
  animation: modeSelectPulse 0.5s ease;
}

.mode-chip:active {
  transform: scale(0.95);
}

/* Notification Modal Slide Down Animation */
@keyframes slideDown {
  0% { transform: translateY(-100%); opacity: 0; }
  100% { transform: translateY(0); opacity: 1; }
}

.notification-modal-slide-down {
  animation: slideDown 0.3s ease-out forwards;
}

/* mode selection */
.mode-selection{padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);cursor:pointer;text-align:center;color:var(--muted2);border:1px solid rgba(255,255,255,0.03);transition:all 0.2s ease}
.mode-selection:hover{background:rgba(255,255,255,0.06);transform:translateY(-2px)}

/* settings inner layout improvements (Rename + Tools kept in Settings) */
.settings-tabs{display:flex;gap:8px;margin-bottom:12px}
.settings-tab{padding:10px 12px;border-radius:999px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted2);cursor:pointer}
.settings-tab.active{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#07213a}
.rename-list{display:grid;grid-template-columns:1fr;gap:8px}
.rename-row{display:flex;gap:8px;align-items:center}
.rename-row input{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted)}

/* tools actions 2 per row */
.tools-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.tools-grid button{padding:10px;border-radius:10px;border:0;cursor:pointer;transition:all 0.3s ease;position:relative;overflow:hidden}
.tools-grid button:active{transform:scale(0.95)}
.tools-grid button:after{content:"";position:absolute;top:50%;left:50%;width:5px;height:5px;background:rgba(255,255,255,0.5);opacity:0;border-radius:100%;transform:scale(1,1) translate(-50%,-50%);transform-origin:50% 50%}
.tools-grid button.pressed:after{animation:ripple 0.6s ease-out}

/* Button animations */
.btn, .ghost, .setup-btn {
  position: relative;
  overflow: hidden;
  transition: all 0.3s ease;
}

.btn:active, .ghost:active, .setup-btn:active {
  transform: scale(0.95);
}

.btn:after, .ghost:after, .setup-btn:after {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  width: 5px;
  height: 5px;
  background: rgba(255,255,255,0.5);
  opacity: 0;
  border-radius: 100%;
  transform: scale(1,1) translate(-50%,-50%);
  transform-origin: 50% 50%;
}

.btn.pressed:after, .ghost.pressed:after, .setup-btn.pressed:after, .wifi-btn.pressed:after {
  animation: ripple 0.6s ease-out;
}

/* Theme-colored buttons */
.btn {
  background: linear-gradient(90deg, var(--accent1), var(--accent2));
  color: #07213a;
  font-weight: 700;
  border: none;
}

/* WiFi buttons */
.wifi-btn {
  position: relative;
  overflow: hidden;
  box-shadow: 0 8px 30px rgba(125,150,255,0.06);
}

.wifi-btn:after {
  content: "";
  display: block;
  position: absolute;
  width: 100%;
  height: 100%;
  top: 0;
  left: 0;
  background: radial-gradient(circle, rgba(255,255,255,0.4) 0%, transparent 70%);
  opacity: 0;
  pointer-events: none;
}

.ghost {
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.08);
  color: var(--muted);
}

.setup-btn {
  padding: 8px 12px;
  border-radius: 10px;
  background: linear-gradient(90deg, var(--accent1), var(--accent2));
  border: 0;
  color: #07213a;
  cursor: pointer;
  font-weight: 700;
  box-shadow: 0 8px 30px rgba(125,150,255,0.06);
}

/* Toggle switch */
.toggle {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 30px;
}

.toggle input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 34px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 22px;
  width: 22px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

.toggle input:checked + .slider {
  background: linear-gradient(90deg, var(--accent1), var(--accent2));
}

.toggle input:checked + .slider:before {
  transform: translateX(30px);
}

/* logs improved */
.log-list{max-height:240px;overflow:auto;padding:0;margin:0;list-style:none}
.log-list li{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:13px;color:var(--muted2);line-height:1.35}

/* Blynk status */
#blynkStatus{font-weight:600}

#blynkDisconnectBtn{margin-left:8px}

@keyframes ripple {
  0% {transform:scale(0,0);opacity:1}
  100% {transform:scale(30,30);opacity:0}
}

/* Popup Notification */
.notification-popup {
  position: fixed;
  top: 20px;
  right: 20px;
  width: 320px;
  background: linear-gradient(180deg, rgba(255,255,255,0.014), rgba(255,255,255,0.008));
  border-radius: 14px;
  padding: 16px;
  border: 1px solid rgba(255,255,255,0.09);
  backdrop-filter: blur(8px);
  box-shadow: 0 10px 30px rgba(13,18,46,0.55);
  z-index: 10000;
  transform: translateX(120%);
  transition: transform 0.3s ease-out;
  cursor: pointer;
}

.notification-popup.show {
  transform: translateX(0);
}

.notification-popup-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.notification-popup-title {
  font-weight: 600;
  font-size: 14px;
}

.notification-popup-close {
  background: none;
  border: none;
  color: var(--muted2);
  cursor: pointer;
  font-size: 16px;
}

.notification-popup-content {
  font-size: 13px;
  color: var(--muted);
}

.notification-popup-timestamp {
  font-size: 11px;
  color: var(--muted2);
  margin-top: 8px;
  text-align: right;
}

/* Mobile-like Notification Popup */
.mobile-notification {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(-100%);
  width: 90%;
  max-width: 400px;
  background: linear-gradient(180deg, rgba(255,255,255,0.014), rgba(255,255,255,0.008));
  border-radius: 14px;
  padding: 16px;
  border: 1px solid rgba(255,255,255,0.09);
  backdrop-filter: blur(8px);
  box-shadow: 0 10px 30px rgba(13,18,46,0.55);
  z-index: 10000;
  transition: transform 0.3s ease-out;
  cursor: pointer;
}

.mobile-notification.show {
  transform: translateX(-50%) translateY(0);
}

.mobile-notification-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.mobile-notification-title {
  font-weight: 600;
  font-size: 14px;
}

.mobile-notification-close {
  background: none;
  border: none;
  color: var(--muted2);
  cursor: pointer;
  font-size: 16px;
}

.mobile-notification-content {
  font-size: 13px;
  color: var(--muted);
}

.mobile-notification-timestamp {
  font-size: 11px;
  color: var(--muted2);
  margin-top: 8px;
  text-align: right;
}
</style>
</head>
<body>

<div id="main">

  <!-- Notification Container -->
  <div id="notificationContainer"></div>

  <!-- header -->
  <div class="header">
    <div class="brand">
      <div class="mark-css">
        <div class="logo-icon">
          <div class="logo-circle"></div>
          <div class="logo-inner"></div>
          <div class="logo-wave"></div>
          <div class="logo-wave"></div>
          <div class="logo-wave"></div>
        </div>
      </div>
      <div>
        <div class="brand-title">SmartSwitch</div>
        <div class="brand-sub">Classroom</div>
        <div class="brand-sub"><a href="https://demonaquarius.github.io/smartlight/" style="color: var(--muted2); text-decoration: none;">GitHub Page</a></div>
      </div>
    </div>

    <div style="display: flex; gap: 12px;">
      <div id="notificationBtn" class="wifi-btn" title="Notifications">
        <div style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">
          <div style="width: 16px; height: 16px; border: 2px solid white; border-radius: 50%; position: relative;">
            <div style="position: absolute; top: -4px; right: -4px; width: 8px; height: 8px; background: #4ef0a0; border-radius: 50%;"></div>
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 2px; height: 2px; background: white; border-radius: 50%;"></div>
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(45deg); width: 6px; height: 2px; background: white; border-radius: 1px;"></div>
          </div>
        </div>
      </div>

      <div id="wifiBtn" class="wifi-btn disconnected" title="Blynk Connection Status">
        <div class="wifi-arc wifi-a3"></div>
        <div class="wifi-arc wifi-a2"></div>
        <div class="wifi-arc wifi-a1"></div>
        <div class="wifi-dot"></div>
      </div>
    </div>
  </div>

  <!-- presence card -->
  <div class="card">
    <div class="status-row">
      <div class="pres-left">
        <div id="presDot" class="pres-dot"></div>
        <div>
          <div style="font-weight:700">Presence</div>
          <div id="presText" class="small">No one</div>
        </div>
      </div>

      <div id="connectionStatus" style="text-align:center;font-size:10px;color:var(--muted2)">Disconnected from Blynk</div>
      <div style="text-align:right">
        <div class="small">Last event</div>
        <div id="lastEvent" class="small">â€”</div>
      </div>
    </div>
  </div>

  <!-- HOME -->
  <div id="homePage">
    <div class="card">
      <div style="font-weight:700;margin-bottom:8px">Lights</div>
      <div id="lightsGrid" class="lights-grid"></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Modes</div>
        <button id="openSetup" class="setup-btn">SETUP</button>
      </div>
      <div class="modes-row">
        <div id="modeTeaching" class="mode" data-mode="teaching">Teaching Mode</div>
        <div id="modeProjector" class="mode" data-mode="projector">Projector Mode</div>
        <div id="modeEnergy" class="mode" data-mode="energy">Energy Saver</div>
      </div>
    </div>
  </div>

  <!-- TIMER -->
  <div id="timerPage" style="display:none">
    <div class="card">
      <h3 style="margin:0 0 8px 0">Schedules</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="schStart" class="input" type="time">
        <input id="schEnd" class="input" type="time">
        <select id="schScene" class="input" style="width:200px"><option value="teaching">Teaching</option><option value="projector">Projector</option><option value="energy">Energy Saver</option></select>
        <button id="addSchedule" class="btn">Add</button>
        <button id="clearSchedules" class="ghost">Clear</button>
      </div>
      <div id="scheduleList" style="margin-top:10px;max-height:160px;overflow:auto"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px 0">Timers</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="tHours" class="input" type="number" min="0" max="23" placeholder="Hours" style="width:110px">
        <input id="tMinutes" class="input" type="number" min="0" max="59" placeholder="Minutes" style="width:110px">
        <input id="tSeconds" class="input" type="number" min="0" max="59" placeholder="Seconds" style="width:110px">
        <select id="tLight" class="input" style="width:180px"></select>
        <button id="addTimer" class="btn">Add Timer</button>
        <button id="clearTimers" class="ghost">Clear</button>
      </div>
      <div id="timersList" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="settingsPage" style="display:none">
    <div class="card">
      <div class="settings-tabs">
        <div class="settings-tab active" data-tab="tabSensors">Sensors</div>
        <div class="settings-tab" data-tab="tabRename">Rename Lights</div>
        <div class="settings-tab" data-tab="tabTools">Tools</div>
      </div>

      <div id="tabSensors">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <div style="display:flex;align-items:center;gap:12px">
            <div class="icon-circle">ðŸ‘¤</div>
            <div>
              <div style="font-weight:700">PIR Sensor</div>
              <div class="small">Motion trigger / Entry</div>
            </div>
          </div>
          <label class="toggle"><input id="pirToggle" type="checkbox"><span class="slider"></span></label>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <div style="display:flex;align-items:center;gap:12px">
            <div class="icon-circle">ðŸ“¡</div>
            <div>
              <div style="font-weight:700">RCWL Radar</div>
              <div class="small">Microwave presence detection</div>
            </div>
          </div>
          <label class="toggle"><input id="rcwlToggle" type="checkbox"><span class="slider"></span></label>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
          <div style="flex:1" class="card">
            <div style="font-weight:700">PIR Settings</div>
            <div class="small" style="margin-top:8px">Delay (seconds)</div>
            <input id="pirDelay" class="input" type="number" min="0" placeholder="e.g. 10" />
          </div>

          <div style="flex:1" class="card">
            <div style="font-weight:700">RCWL Settings</div>
            <div class="small" style="margin-top:8px">Range (%)</div>
            <input id="rcwlRange" type="range" min="0" max="100" value="70" style="width:100%" />
            <div id="rcwlVal" class="small" style="margin-top:6px">70%</div>
          </div>
        </div>
      </div>

      <div id="tabRename" style="display:none">
        <h3 style="margin-top:0">Rename Lights</h3>
        <div id="renameList" class="rename-list" style="margin-top:8px"></div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="saveRename" class="btn">Save</button>
          <button id="resetNames" class="ghost">Reset Defaults</button>
        </div>
      </div>

      <div id="tabTools" style="display:none">
        <h3 style="margin-top:0">Tools & Quick Actions</h3>
        
        <!-- Blynk Integration Section -->
        <div class="card" style="margin-bottom:12px">
          <div style="font-weight:600;margin-bottom:8px">Blynk Integration</div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <div style="display:flex;align-items:center;gap:8px">
              <input type="text" id="blynkTokenInput" placeholder="Enter Blynk Auth Token" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted)">
              <button id="blynkConnectBtn" class="btn" style="padding:8px 12px">Connect</button>
              <button id="blynkDisconnectBtn" class="ghost" style="padding:8px 12px">Disconnect</button>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <div class="small">Status:</div>
              <div id="blynkStatus" class="small" style="color:#ff9a9a">Not connected</div>
            </div>
            <div class="small" style="color:#7fb1ff">Predefined token for 'smartboard' template is automatically loaded</div>
          </div>
        </div>
        
        <div class="tools-grid" style="margin-top:8px">
          <button id="refreshBtn" class="btn">Refresh Device</button>
          <button id="restartBtn" class="ghost">Restart Device</button>
          <button id="clearLogsBtn" class="ghost">Clear Logs</button>
          <button id="exportConfigBtn" class="btn">Export Config</button>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="font-weight:600;margin-bottom:8px">Logs (latest 10)</div>
          <ul id="logs" class="log-list"></ul>
        </div>
      </div>
    </div>
  </div>

</div> <!-- end main -->
<!-- bottom navbar -->
<div id="navbar">
  <div class="bottom-nav" role="navigation">
    <div class="nav-item active" data-page="home"><div class="home-icon-modern"></div><div style="margin-top:8px;font-size:13px">Home</div></div>
    <div class="nav-item" data-page="timer"><div class="clock-icon-modern"></div><div style="margin-top:8px;font-size:13px">Timer</div></div>
    <div class="nav-item" data-page="settings"><div class="gear-icon-modern"><div class="gear-tooth t1"></div><div class="gear-tooth t2"></div><div class="gear-tooth t3"></div><div class="gear-tooth t4"></div><div class="gear-tooth t5"></div><div class="gear-tooth t6"></div><div class="gear-tooth t7"></div><div class="gear-tooth t8"></div><div class="gear-tooth t9"></div><div class="gear-tooth t10"></div><div class="gear-tooth t11"></div><div class="gear-tooth t12"></div></div><div style="margin-top:8px;font-size:13px">Settings</div></div>
  </div>
</div>

<!-- Centered Mode Setup modal -->
<div id="modeModal" class="modal-back" style="display: none;">
  <div class="modal" role="dialog" aria-modal="true">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:700" id="modeModalTitle">Mode Setup</div>
      <button id="closeMode" class="ghost">Close</button>
    </div>
    <div style="margin-top:12px" class="mode-grid" id="modeModalGrid"></div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="modeSaveBtn" class="btn">Save</button>
    </div>
  </div>
</div>

<!-- Blynk-only mode notification -->
<div id="wifiModal" class="modal-back" style="display: none;">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:700">Wi-Fi Manager</div>
      <div id="wifiStatusText" class="small">Device Controlled via Blynk Cloud</div>
    </div>

    <div style="margin-top:16px">
      <!-- WiFi list -->
      <div style="margin-bottom:12px">
        <div style="font-weight:600">Saved Wi-Fi Networks</div>
        <div id="wifiListArea" style="margin-top:8px"></div>
      </div>

      <!-- Add / Edit form -->
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap">
        <input id="newSsid" placeholder="SSID" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted)">
        <input id="newPass" placeholder="Password" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted)">
        <button id="addWifiBtn" class="btn">Add / Save</button>
      </div>

      <div style="display:flex;gap:8px;align-items:center;margin-top:12px">
        <button id="applyWifiBtn" class="btn">Apply Selected to Device</button>
        <button id="setDefaultWifiBtn" class="ghost">Set Selected as Default</button>
        <button id="exportWifiBtn" class="ghost">Export</button>
      </div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.04);margin-top:12px"/>

      <div style="display:flex;gap:8px;align-items:center;margin-top:12px">
        <div style="flex:1">
          <div style="font-weight:600">Presence Auto-Off Timeout (seconds)</div>
          <div class="small">When 'No presence' persists this long, lights will automatically be turned off.</div>
        </div>
        <input id="autoOffTimeout" type="number" min="0" step="1" placeholder="e.g. 120" style="width:140px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted)">
      </div>

      <div style="display:flex;justify-content:center;margin-top:16px">
        <button id="closeWifi" class="ghost">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Notification Modal (Device Notifications) -->
<div id="notificationModal" class="modal-back" style="align-items: flex-start; padding-top: 20px; display: none;">
  <div class="modal" style="height: 80vh; display: flex; flex-direction: column; margin-top: 0;">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:700">Device Notifications</div>
      <button id="closeNotification" class="ghost">Close</button>
    </div>
    
    <div style="margin-top:16px; flex: 1; display: flex; flex-direction: column; overflow: hidden;">
      <!-- ESP32 STATUS CARD -->
      <div id="espStatusCard" class="card" style="margin-bottom:15px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <div style="font-size:16px;font-weight:600;">ESP32 Device Status</div>
          <div id="espStatusDot" style="width:12px;height:12px;border-radius:50%;background:#ff6b6b;"></div>
        </div>

        <div class="small">Status: <strong id="espStatusText">Offline</strong></div>
        <div class="small" style="margin-top:6px;">IP: <span id="espIp">â€”</span></div>
        <div class="small" style="margin-top:6px;">Uptime: <span id="espUptime">â€”</span></div>
        <div class="small" style="margin-top:6px;">Last Seen: <span id="espLastSeen">â€”</span></div>

        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px;">
          <button id="requestEspStatusBtn" class="ghost">Request Status</button>
          <button id="focusEspLogsBtn" class="btn">Show Logs</button>
        </div>
      </div>

      <div class="card" style="margin-bottom:12px; display: flex; justify-content: space-between; align-items: center;">
        <div style="font-weight:600;margin-bottom:8px">Connection Status</div>
        <div id="connectionStatusDetail" class="small">Disconnected</div>
      </div>
      
      <div class="card" style="margin-bottom:12px">
        <div style="font-weight:600;margin-bottom:8px">Sensor Status</div>
        <div class="small">PIR Sensor: <span id="pirStatus">Enabled</span></div>
        <div class="small">RCWL Radar: <span id="rcwlStatus">Enabled</span></div>
        <div class="small">Presence Detection: <span id="presenceStatus">No one detected</span></div>
      </div>
      
      <div class="card" style="margin-bottom:12px; display: flex; justify-content: space-between; align-items: center;">
        <div style="font-weight:600;margin-bottom:8px">Blynk</div>
        <div id="blynkIntegrationStatus" class="small">Not connected</div>
      </div>
    </div>
  </div>
</div>
<script>
console.log('Script is loading...');

/* ---------- State & helpers ---------- */
const STORAGE = 'smart_ui_final_v1';

// Security module for token encryption
const SecurityModule = {
  encrypt: function(text, key) {
    if (!text) return '';
    try {
      const encoder = new TextEncoder();
      const data = encoder.encode(text);
      const keyData = encoder.encode(key);
      let result = new Uint8Array(data.length);
      for (let i = 0; i < data.length; i++) {
        result[i] = data[i] ^ keyData[i % keyData.length];
      }
      return btoa(String.fromCharCode(...result));
    } catch (e) {
      console.warn('Failed to encrypt token:', e.message);
      return '';
    }
  },
  decrypt: function(encryptedText, key) {
    if (!encryptedText) return '';
    try {
      const decoder = new TextDecoder();
      const data = new Uint8Array(atob(encryptedText).split('').map(c => c.charCodeAt(0)));
      const keyData = new TextEncoder().encode(key);
      let result = new Uint8Array(data.length);
      for (let i = 0; i < data.length; i++) {
        result[i] = data[i] ^ keyData[i % keyData.length];
      }
      return decoder.decode(result);
    } catch (e) {
      console.warn('Failed to decrypt token:', e.message);
      return '';
    }
  },
  generateDeviceKey: function() {
    const fingerprint = [
      navigator.userAgent,
      navigator.language,
      screen.width,
      screen.height,
      new Date().getTimezoneOffset()
    ].join('|');
    let hash = 0;
    for (let i = 0; i < fingerprint.length; i++) {
      const char = fingerprint.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash;
    }
    return 'key_' + Math.abs(hash).toString(36);
  }
};

function defaultState(){
  const names = ["Front Light","Board Light","Left Wall","Right Wall","Center 1","Center 2","Back Left","Back Right"];
  return {
    lights: names.map((n,i)=>({id:i,name:n,on:false,manual:false})),
    modeProjector: Array(8).fill(false),
    modeEnergy: Array(8).fill(false),
    presence:false,pir:true,rcwl:true,pirDelay:5,rcwlRange:70,
    schedules:[],timers:[],logs:[],wifiConnected:false,
    // new: wifi creds manager â€” starts with your requested default
    wifiCreds: [
      { ssid: 'vivot3lite', pass: '12345678', note: 'default (vivot3lite)' }
    ],
    wifiSelected: 0,
    wifiDefaultIndex: 0,
    // auto-off timeout in seconds after 'no presence' to switch off lights
    autoOffTimeout: 120,
    lastESPInfo: { ip: null }, // store last ESP info (ip, uptime)
    espOnline: false,
    espIp: "â€”",
    espUptime: "â€”",
    espLastSeen: null,
    // Track if token has been determined to be invalid to avoid spamming requests
    tokenInvalid: false,
  };
}
let state = (()=>{ try{ const r = localStorage.getItem(STORAGE); return r? JSON.parse(r): defaultState(); }catch(e){ return defaultState(); } })();
function saveState(){ localStorage.setItem(STORAGE, JSON.stringify(state)); }
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function escapeHtml(s){ return String(s).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

let apiToken = '';

// getApiToken function to retrieve Blynk API token
function getApiToken() {
  // In a real implementation, this would fetch the API token from Blynk
  // For now, we'll just log that the function was called
  console.log('Getting API token...');
  // This is a placeholder - in a full implementation you would make an API call here
}
function log(msg){ state.logs.unshift(new Date().toLocaleString() + ' â€” ' + msg); if(state.logs.length>800) state.logs.length=800; saveState(); renderLogs(true); 
  const importantEvents = [
    'Connected to','Disconnected','Connection failed','Device connected','Device disconnected',
    'OTA update initiated','Presence detected','No presence detected','Blynk connected','Blynk disconnected'
  ];
  if (importantEvents.some(event => msg.includes(event))) {
    let title = 'Notification';
    if (msg.includes('Connected to')) title = 'Connected';
    else if (msg.includes('Disconnected') || msg.includes('Connection failed')) title = 'Connection Issue';
    else if (msg.includes('Device connected')) title = 'Device Online';
    else if (msg.includes('Device disconnected')) title = 'Device Offline';
    else if (msg.includes('OTA update')) title = 'OTA Update';
    else if (msg.includes('Presence detected')) title = 'Presence Detected';
    else if (msg.includes('No presence detected')) title = 'No Presence';
    else if (msg.includes('Blynk connected')) title = 'Blynk Connected';
    else if (msg.includes('Blynk disconnected')) title = 'Blynk Disconnected';
    showPopupNotification(title, msg);
  }
}

// Popup notification functions
function showPopupNotification(title, message) {
  // Create notification element if it doesn't exist
  let notification = document.getElementById('notificationPopup');
  if (!notification) {
    notification = document.createElement('div');
    notification.id = 'notificationPopup';
    notification.className = 'notification-popup';
    notification.innerHTML = `
      <div class="notification-popup-header">
        <div class="notification-popup-title">${escapeHtml(title)}</div>
        <button class="notification-popup-close">Ã—</button>
      </div>
      <div class="notification-popup-content">${escapeHtml(message)}</div>
      <div class="notification-popup-timestamp">${new Date().toLocaleTimeString()}</div>
    `;
    document.body.appendChild(notification);
    
    // Add close event
    notification.querySelector('.notification-popup-close').addEventListener('click', function() {
      notification.classList.remove('show');
    });
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
      notification.classList.remove('show');
    }, 5000);
  } else {
    // Update existing notification
    notification.querySelector('.notification-popup-title').textContent = title;
    notification.querySelector('.notification-popup-content').textContent = message;
    notification.querySelector('.notification-popup-timestamp').textContent = new Date().toLocaleTimeString();
  }
  
  // Show notification
  notification.classList.add('show');
}

function showMobileNotification(title, message) {
  // Create mobile notification element if it doesn't exist
  let notification = document.getElementById('mobileNotification');
  if (!notification) {
    notification = document.createElement('div');
    notification.id = 'mobileNotification';
    notification.className = 'mobile-notification';
    notification.innerHTML = `
      <div class="mobile-notification-header">
        <div class="mobile-notification-title">${escapeHtml(title)}</div>
        <button class="mobile-notification-close">Ã—</button>
      </div>
      <div class="mobile-notification-content">${escapeHtml(message)}</div>
      <div class="mobile-notification-timestamp">${new Date().toLocaleTimeString()}</div>
    `;
    document.body.appendChild(notification);
    
    // Add close event
    notification.querySelector('.mobile-notification-close').addEventListener('click', function() {
      notification.classList.remove('show');
    });
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
      notification.classList.remove('show');
    }, 5000);
  } else {
    // Update existing notification
    notification.querySelector('.mobile-notification-title').textContent = title;
    notification.querySelector('.mobile-notification-content').textContent = message;
    notification.querySelector('.mobile-notification-timestamp').textContent = new Date().toLocaleTimeString();
  }
  
  // Show notification
  notification.classList.add('show');
}

// RENDER FUNCTIONS (lights, rename list, timers, schedules)
function renderLights() {
  const grid = $('#lightsGrid'); grid.innerHTML='';
  state.lights.slice(0,6).forEach(l=>{
    const el = document.createElement('div'); el.className = 'light-block' + (l.on? ' on':'');
    el.innerHTML = `<div class="circle" data-id="${l.id}"><div class="bulb">ðŸ’¡</div><div class="inner-status">${l.on?'ON':'OFF'}</div></div><div class="nameBelow">${escapeHtml(l.name)}</div>`;
    el.querySelector('.circle').addEventListener('click', ()=>sendToggleWS(l.id));
    el.querySelector('.circle').addEventListener('contextmenu', e=>{ e.preventDefault(); renamePrompt(l.id); });
    grid.appendChild(el);
  });
  const lastRow = document.createElement('div'); lastRow.className='last-row';
  state.lights.slice(6).forEach(l=>{
    const el = document.createElement('div'); el.className = 'light-block' + (l.on? ' on':'');
    el.innerHTML = `<div class="circle" data-id="${l.id}"><div class="bulb">ðŸ’¡</div><div class="inner-status">${l.on?'ON':'OFF'}</div></div><div class="nameBelow">${escapeHtml(l.name)}</div>`;
    el.querySelector('.circle').addEventListener('click', ()=>sendToggleWS(l.id));
    el.querySelector('.circle').addEventListener('contextmenu', e=>{ e.preventDefault(); renamePrompt(l.id); });
    lastRow.appendChild(el);
  });
  grid.appendChild(lastRow);
  $('#presDot').classList.toggle('on', !!state.presence);
  $('#presText').textContent = state.presence ? 'Someone' : 'No one';
  saveState();
}

function toggleLight(id){
  sendToggleWS(id);
  if (blynkConnected) {
    const light = state.lights.find(l => l.id === id);
    if (light) {
      sendToBlynk(`V${id}`, light.on ? 0 : 1);
    }
  }
}
function renamePrompt(id){
  const cur = state.lights.find(x=>x.id===id).name; const v = prompt('Rename light', cur);
  if(v!==null && v.trim()!==''){ state.lights[id].name = v.trim(); log(`Renamed light ${id+1} â†’ ${v.trim()}`); saveState(); renderLights(); renderRenameList(); populateTimerSelect(); }
}
function sendToggleWS(id) {
  // update local optimistic UI
  const light = state.lights.find(l => l.id === id);
  if (light) { light.on = !light.on; saveState(); renderLights(); }
  if (blynkConnected) { sendToBlynk(`V${id}`, state.lights[id].on ? 1 : 0); }
}





function applyMode(mode){
  if(mode==='projector'){ state.lights.forEach((l,i)=> l.on = !!state.modeProjector[i]); log('Projector Mode applied'); }
  if(mode==='energy'){ state.lights.forEach((l,i)=> l.on = !!state.modeEnergy[i]); log('Energy Saver applied'); }
  saveState(); renderLights();
}

function renderLogs() {
  const logsContainer = document.getElementById('logs');
  if (!logsContainer) return;
  
  logsContainer.innerHTML = '';
  state.logs.slice(0, 10).forEach(logEntry => {
    const li = document.createElement('li');
    li.textContent = logEntry;
    logsContainer.appendChild(li);
  });
}

function renderSchedules(){ 
  const out = $('#scheduleList'); 
  out.innerHTML=''; 
  state.schedules.forEach((s,i)=>{ 
    const r = document.createElement('div'); 
    r.style.padding='8px'; 
    r.style.borderBottom='1px solid rgba(255,255,255,0.03)'; 
    r.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${escapeHtml(s.start)}</strong> â†’ <strong>${escapeHtml(s.end)}</strong> â€¢ ${escapeHtml(s.scene)}</div><div><button data-del="${i}" class="ghost">Delete</button></div></div>`; 
    out.appendChild(r); 
  }); 
  $$('[data-del]').forEach(b=> b.onclick = e=> { 
    const i = +e.target.dataset.del; 
    addButtonAnimation(e.target.id || 'deleteSchedule'); 
    state.schedules.splice(i,1); 
    saveState(); 
    renderSchedules(); 
    log('Schedule removed'); 
  }); 
}

function renderTimers(){ 
  const area = $('#timersList'); 
  area.innerHTML=''; 
  state.timers.forEach((t,i)=>{ 
    const d = document.createElement('div'); 
    d.className='card'; 
    d.style.display='flex'; 
    d.style.justifyContent='space-between'; 
    d.style.alignItems='center'; 
    d.style.marginBottom='8px'; 
    d.innerHTML = `<div><strong>${escapeHtml(t.name)}</strong><div class="small">${t.h}h ${t.m}m ${t.s}s</div></div><div><button data-deltimer="${i}" class="ghost">Remove</button></div>`; 
    area.appendChild(d); 
  }); 
  $$('[data-deltimer]').forEach(b=> b.onclick = e=> { 
    const i=+e.target.dataset.deltimer; 
    addButtonAnimation(e.target.id || 'deleteTimer'); 
    state.timers.splice(i,1); 
    saveState(); 
    renderTimers(); 
    log('Timer removed'); 
  }); 
}

function populateTimerSelect(){ 
  const sel = $('#tLight'); 
  sel.innerHTML=''; 
  state.lights.forEach(l=>{ 
    const o = document.createElement('option'); 
    o.value = l.id; 
    o.textContent = l.name; 
    sel.appendChild(o); 
  }); 
}

function initUI() { 
  console.log('initUI called'); 
  renderLights(); 
  renderRenameList(); 
  renderSchedules(); 
  renderTimers(); 
  renderLogs(); 
  populateTimerSelect();
  if(state.wifiConnected) { $('#wifiBtn').classList.add('connected'); $('#wifiBtn').classList.remove('disconnected'); } else { $('#wifiBtn').classList.add('disconnected'); $('#wifiBtn').classList.remove('connected'); }
  $('#pirToggle').checked = !!state.pir; $('#rcwlToggle').checked = !!state.rcwl; $('#pirDelay').value = state.pirDelay; $('#rcwlRange').value = state.rcwlRange; $('#rcwlVal').textContent = state.rcwlRange + '%';
  initRenameListeners(); initToolsListeners(); initSettingsTabListeners();
  // Set up mode buttons
  $('#modeTeaching').addEventListener('click', function() { 
    addButtonAnimation('modeTeaching');
    state.lights.forEach(l=> l.on = true); log('Teaching Mode applied (all ON)'); saveState(); renderLights(); 
    if (blynkConnected) { updateBlynkModeIndicator('teaching'); updateBlynkLightsState(); }
  });
  
  $('#modeProjector').addEventListener('click', function() { 
    addButtonAnimation('modeProjector');
    applyMode('projector'); 
    if (blynkConnected) { updateBlynkModeIndicator('projector'); updateBlynkLightsState(); }
  });
  
  $('#modeEnergy').addEventListener('click', function() { 
    addButtonAnimation('modeEnergy');
    applyMode('energy'); 
    if (blynkConnected) { updateBlynkModeIndicator('energy'); updateBlynkLightsState(); }
  });
  
  // ensure wifi list UI is good
  renderWifiList();
  // set autoOffTimeout input
  if ($('#autoOffTimeout')) $('#autoOffTimeout').value = state.autoOffTimeout;
}

// Important: update any sendToBlynk('V10', ...) used for presence to use V28 instead
// For example anywhere you previously had sendToBlynk('V10', state.presence ? 1 : 0); replace with:
function sendPresenceToBlynk() {
  // Use V28 for presence so V10 is free for UI connection status
  if (blynkConnected) sendToBlynk('V28', state.presence ? 1 : 0);
}/* ---------- WiFi manager functions (new) ---------- */

// Render WiFi list in modal
function renderWifiList() {
  const area = $('#wifiListArea');
  area.innerHTML = '';
  if (!state.wifiCreds || state.wifiCreds.length === 0) {
    area.innerHTML = `<div class="small">No saved networks</div>`;
    return;
  }
  state.wifiCreds.forEach((w, idx) => {
    const el = document.createElement('div');
    el.style.display = 'flex';
    el.style.justifyContent = 'space-between';
    el.style.alignItems = 'center';
    el.style.padding = '8px';
    el.style.borderBottom = '1px solid rgba(255,255,255,0.03)';
    el.innerHTML = `
      <div style="flex:1">
        <div style="font-weight:600">${escapeHtml(w.ssid)}</div>
        <div class="small">${escapeHtml(w.note || '')}</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <input type="radio" name="wifiSel" data-idx="${idx}" ${state.wifiSelected===idx ? 'checked':''} title="Select to apply">
        <button data-edit="${idx}" class="ghost" title="Edit">Edit</button>
        <button data-del="${idx}" class="ghost" title="Delete">Delete</button>
      </div>
    `;
    area.appendChild(el);
  });

  // attach handlers
  $$('input[name="wifiSel"]').forEach(r => r.addEventListener('change', (e)=>{
    const idx = +e.target.dataset.idx;
    state.wifiSelected = idx; saveState();
  }));

  $$('[data-edit]').forEach(b => b.addEventListener('click', (e)=>{
    const idx = +e.target.dataset.edit;
    $('#newSsid').value = state.wifiCreds[idx].ssid;
    $('#newPass').value = state.wifiCreds[idx].pass;
    $('#addWifiBtn').dataset.editing = idx;
  }));

  $$('[data-del]').forEach(b => b.addEventListener('click', (e)=>{
    const idx = +e.target.dataset.del;
    if (confirm('Delete network "' + state.wifiCreds[idx].ssid + '"?')) {
      state.wifiCreds.splice(idx,1);
      if (state.wifiSelected >= state.wifiCreds.length) state.wifiSelected = Math.max(0, state.wifiCreds.length-1);
      if (state.wifiDefaultIndex >= state.wifiCreds.length) state.wifiDefaultIndex = 0;
      saveState(); renderWifiList();
      log('Wi-Fi credential deleted');
    }
  }));
}

// Add or update wifi cred
$('#addWifiBtn')?.addEventListener('click', () => {
  const ssid = $('#newSsid').value.trim();
  const pass = $('#newPass').value;
  if (!ssid) { showMobileNotification('Error','SSID required'); return; }
  if ($('#addWifiBtn').dataset.editing) {
    const idx = +$('#addWifiBtn').dataset.editing;
    state.wifiCreds[idx] = { ssid, pass, note: 'edited' };
    delete $('#addWifiBtn').dataset.editing;
    log('Wi-Fi updated: ' + ssid);
  } else {
    state.wifiCreds.push({ ssid, pass, note: '' });
    log('Wi-Fi added: ' + ssid);
  }
  $('#newSsid').value = ''; $('#newPass').value = '';
  saveState();
  renderWifiList();
});

// Apply selected wifi creds to device (via Blynk virtual pins V30 and V31)
$('#applyWifiBtn')?.addEventListener('click', () => {
  if (!state.wifiCreds || state.wifiCreds.length === 0) { showMobileNotification('Error','No credentials saved'); return; }
  const sel = state.wifiSelected || 0;
  const cred = state.wifiCreds[sel];
  if (!cred) { showMobileNotification('Error','Selected credential not found'); return; }
  // Send SSID and PASS to device via Blynk virtual pins
  sendToBlynk('V30', cred.ssid);
  sendToBlynk('V31', cred.pass);
  showMobileNotification('Wi-Fi', `Sent SSID "${cred.ssid}" to device`);
  log(`Applied Wi-Fi to device: ${cred.ssid}`);
});

// Set selected as default (UI-level default, also stored)
$('#setDefaultWifiBtn')?.addEventListener('click', () => {
  if (!state.wifiCreds || state.wifiCreds.length === 0) { showMobileNotification('Error','No credentials saved'); return; }
  state.wifiDefaultIndex = state.wifiSelected || 0;
  saveState();
  showMobileNotification('Default Wi-Fi', `Saved "${state.wifiCreds[state.wifiDefaultIndex].ssid}" as default`);
  log('Default Wi-Fi set');
});

// Export wifi creds (download as JSON)
$('#exportWifiBtn')?.addEventListener('click', () => {
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state.wifiCreds, null, 2));
  const a = document.createElement('a'); a.setAttribute('href', dataStr); a.setAttribute('download', 'wifi_creds.json'); document.body.appendChild(a); a.click(); a.remove();
  showMobileNotification('Export', 'Wi-Fi list exported');
});

/* ---------- Presence timeout (auto-off) ---------- */

// Load timeout UI and save/apply
$('#autoOffTimeout')?.addEventListener('change', () => {
  const v = parseInt($('#autoOffTimeout').value || 0, 10);
  state.autoOffTimeout = isNaN(v) ? 0 : v;
  saveState();
  // Send to device over Blynk virtual pin V33
  sendToBlynk('V33', state.autoOffTimeout);
  showMobileNotification('Timeout', `Auto-Off timeout set to ${state.autoOffTimeout} seconds`);
  log('Auto-off timeout set: ' + state.autoOffTimeout + 's');
});

// Load timeout UI and save/apply
$('#autoOffTimeout')?.addEventListener('change', () => {
  const v = parseInt($('#autoOffTimeout').value || 0, 10);
  state.autoOffTimeout = isNaN(v) ? 0 : v;
  saveState();
  // Send to device over Blynk virtual pin V33
  sendToBlynk('V33', state.autoOffTimeout);
  showMobileNotification('Timeout', `Auto-Off timeout set to ${state.autoOffTimeout} seconds`);
  log('Auto-off timeout set: ' + state.autoOffTimeout + 's');
});

/* ===== BLYNK REST (replace WebSocket logic) =====

   Drop-in replacement: initBlynk, disconnectBlynk, sendToBlynk, poll loop

*/

let blynkConnected = false;
let blynkToken = '';
let blynkPollInterval = null;
const BLYNK_API_BASE = 'https://blynk.cloud/external/api';

function setBlynkUIConnected(yes) {
  blynkConnected = !!yes;
  const statusEl = document.getElementById('blynkStatus');
  if (statusEl) {
    statusEl.textContent = yes ? 'Connected to Blynk (REST)' : 'Disconnected from Blynk';
    statusEl.style.color = yes ? '#4ef0a0' : '#ff9a9a';
  }
}

// Initialize Blynk REST usage with token
function initBlynk(token) {
  if (!token) return;
  blynkToken = token;
  
  // Reset token invalid flag when trying a new token
  state.tokenInvalid = false;
  
  // Validate token format
  if (token.length !== 32 || !/^[a-zA-Z0-9_-]+$/.test(token)) {
    console.warn('Invalid Blynk token format');
    showPopupNotification('Blynk Error', 'Invalid token format. Token should be 32 characters.');
    return;
  }
  
  // Save encrypted token as before (keeps compatibility)
  try {
    const deviceKey = SecurityModule.generateDeviceKey();
    localStorage.setItem('blynkToken', SecurityModule.encrypt(token, deviceKey));
  } catch (e) { console.warn('token save failed', e); }

  // Test token with a simple request
  getBlynkPin('V0').then(() => {
    // mark UI connected (we consider REST available if token provided)
    setBlynkUIConnected(true);
    showPopupNotification('Blynk', 'Using Blynk REST API (token loaded)');
    // start polling device/cloud pins
    startBlynkPoll();
  }).catch(err => {
    console.warn('Token validation failed:', err);
    showPopupNotification('Blynk Error', 'Token validation failed. Check token and network connection.');
    setBlynkUIConnected(false);
  });
}

// Graceful disconnect (stop poll, clear token optionally)
function disconnectBlynk() {
  if (blynkPollInterval) { clearInterval(blynkPollInterval); blynkPollInterval = null; }
  blynkToken = '';
  setBlynkUIConnected(false);
  localStorage.removeItem('blynkToken');
  document.getElementById('blynkTokenInput').value = '';
  showPopupNotification('Blynk', 'Disconnected (REST)');
  // Reset token invalid flag
  state.tokenInvalid = false;
}

// Send to Blynk via REST update endpoint
// pin format: 'V0' or 'V25' etc. value can be number or string
function sendToBlynk(pin, value) {
  if (!blynkToken) {
    console.warn('No Blynk token â€” cannot send', pin, value);
    return Promise.reject(new Error('No token'));
  }

  // build URL like: /external/api/update?token=TOKEN&V0=1
  const url = `${BLYNK_API_BASE}/update?token=${encodeURIComponent(blynkToken)}&${encodeURIComponent(pin)}=${encodeURIComponent(String(value))}`;
  return fetch(url, { method: 'GET' })
    .then(resp => {
      if (!resp.ok) {
        if (resp.status === 400) {
          // Mark token as potentially invalid to avoid spamming requests
          state.tokenInvalid = true;
          throw new Error(`HTTP ${resp.status} - Bad Request. Pin ${pin} may not exist or token is invalid.`);
        } else if (resp.status === 401) {
          // Mark token as invalid
          state.tokenInvalid = true;
          throw new Error(`HTTP ${resp.status} - Unauthorized. Invalid token.`);
        } else {
          throw new Error(`HTTP ${resp.status}`);
        }
      }
      // Blynk returns "OK" text for update endpoint typically
      console.log('Blynk update OK', pin, value);
      return resp.text();
    })
    .catch(err => {
      console.warn('Blynk REST send failed', err);
      setBlynkUIConnected(false);
      return Promise.reject(err);
    });
}

// Read one pin using REST get endpoint.
// Some Blynk servers return plain value or JSON array; handle both.
function getBlynkPin(pin) {
  if (!blynkToken) return Promise.reject(new Error('No token'));
  // Correct Blynk REST API format for get: /get?token=TOKEN&pin=V0
  const url = `${BLYNK_API_BASE}/get?token=${encodeURIComponent(blynkToken)}&pin=${encodeURIComponent(pin)}`;
  return fetch(url, { method: 'GET' })
    .then(resp => {
      if (!resp.ok) {
        if (resp.status === 400) {
          // Mark token as potentially invalid to avoid spamming requests
          state.tokenInvalid = true;
          throw new Error(`HTTP ${resp.status} - Bad Request. Pin ${pin} may not exist or token is invalid.`);
        } else if (resp.status === 401) {
          // Mark token as invalid
          state.tokenInvalid = true;
          throw new Error(`HTTP ${resp.status} - Unauthorized. Invalid token.`);
        } else {
          throw new Error(`HTTP ${resp.status}`);
        }
      }
      return resp.text();
    })
    .then(txt => {
      // try to parse JSON if possible, otherwise return raw trimmed text
      try {
        // some Blynk variants return '["value"]' â€” try JSON parse
        const parsed = JSON.parse(txt);
        if (Array.isArray(parsed) && parsed.length) return parsed[0];
        return parsed;
      } catch (e) {
        return txt.trim();
      }
    })
    .catch(err => {
      console.warn('Blynk REST get failed', pin, err);
      // Don't disconnect the entire UI for individual pin failures
      // Just return null to indicate the pin couldn't be read
      return Promise.resolve(null);
    });
}

// Poll a set of important pins and update UI/state
function pollBlynkPinsOnce() {
  if (!blynkToken) return;
  
  // Validate token format before polling
  if (blynkToken.length !== 32 || !/^[a-zA-Z0-9_-]+$/.test(blynkToken)) {
    console.warn('Invalid Blynk token format, skipping poll');
    return;
  }
  
  // Check if we've already determined the token is invalid to avoid spamming requests
  if (state.tokenInvalid) {
    console.warn('Skipping poll due to previously invalid token');
    return;
  }
  // pins to poll: V0..V7 (lights), V8 (UI heartbeat), V9 (ESP status), V10 (presence), V11 (pir), V12(rcwl), V33(auto-off)
  const pins = ['V0','V1','V2','V3','V4','V5','V6','V7','V8','V9','V10','V11','V12','V33','V25'];
  // poll sequentially (simple) â€” could be parallel but keep simple for reliability
  pins.reduce((p, pin) => {
    return p.then(() => getBlynkPin(pin)
      .then(val => {
        // If val is null, the pin couldn't be read, so skip processing
        if (val === undefined || val === null) return;
        // process result by pin
        const n = pin.replace(/^V/, '');
        const pinNum = parseInt(n);
        if (!isNaN(pinNum) && pinNum >=0 && pinNum <=7) {
          // light state: numeric 0/1
          const v = (String(val).trim() === '1' || String(val).toLowerCase()==='true');
          state.lights[pinNum].on = v;
        } else if (pin === 'V8') {
          // UI heartbeat (not used much)
        } else if (pin === 'V9') {
          // device status string - update display
          const el = document.getElementById('espStatusText');
          if (el) el.textContent = String(val).slice(0,80);
        } else if (pin === 'V10') {
          const pval = (String(val).trim() === '1' || String(val).toLowerCase()==='true');
          handlePresenceChange(pval); // reuse existing handler
        } else if (pin === 'V11') {
          state.pir = (String(val).trim() === '1' || String(val).toLowerCase()==='true');
          $('#pirToggle').checked = !!state.pir;
        } else if (pin === 'V12') {
          state.rcwl = (String(val).trim() === '1' || String(val).toLowerCase()==='true');
          $('#rcwlToggle').checked = !!state.rcwl;
        } else if (pin === 'V33') {
          state.autoOffTimeout = parseInt(val) || state.autoOffTimeout;
          if ($('#autoOffTimeout')) $('#autoOffTimeout').value = state.autoOffTimeout;
        } else if (pin === 'V25') {
          // terminal text from device: append
          const txt = String(val);
          if (txt && txt.length) appendTerminalLine(`<device> ${txt}`);
        }
      })
      .catch(()=>{/* ignore pin read failure for single pin */})
    );
  }, Promise.resolve())
  .then(() => {
    // after polling all pins, render lights
    renderLights();
    setBlynkUIConnected(true);
  })
  .catch(err => {
    console.warn('Polling sequence error', err);
  });
}

// Start poller
function startBlynkPoll() {
  // immediately poll once
  pollBlynkPinsOnce();
  // then periodic poll (6s)
  if (blynkPollInterval) clearInterval(blynkPollInterval);
  blynkPollInterval = setInterval(pollBlynkPinsOnce, 6000);
}

// Stop poller (used by disconnect)
function stopBlynkPoll() {
  if (blynkPollInterval) { clearInterval(blynkPollInterval); blynkPollInterval = null; }
}

// Hook into existing connect/disconnect buttons
// (this keeps your UI button logic unchanged)
document.getElementById('blynkConnectBtn')?.addEventListener('click', function() {
  addButtonAnimation('blynkConnectBtn');
  const token = $('#blynkTokenInput').value.trim() || (function(){
    // fallback to preloaded token (hardcoded template token in UI)
    return 'GO_I2vtWFmQbPclq0JU7Wy5CWA9aXtsO';
  })();
  if (!token) { showMobileNotification('Error','Blynk token required'); return; }
  initBlynk(token);
});

document.getElementById('blynkDisconnectBtn')?.addEventListener('click', function() {
  addButtonAnimation('blynkDisconnectBtn');
  disconnectBlynk();
});

// Replace previous UI-heartbeat sender: use REST
setInterval(() => {
  if (blynkConnected && blynkToken) {
    // write UI heartbeat V8 and presence V10 when presence changes elsewhere
    sendToBlynk('V8', 1).catch(()=>{});
  }
}, 8000);

// When page closes, send UI offline (best-effort)
window.addEventListener("beforeunload", () => {
  if (blynkConnected && blynkToken) {
    // best-effort; fire-and-forget
    navigator.sendBeacon(`${BLYNK_API_BASE}/update?token=${encodeURIComponent(blynkToken)}&V8=0`);
  }
});

// Disable old tryConnectWebSocket / mDNS code â€” comment out calls to it
// If you had a tryConnectWebSocket() invocation earlier, remove it or replace with initBlynk(savedToken) as below:

// on load: auto-init from saved token (if present)
(function autoInitSavedToken(){
  try {
    const enc = localStorage.getItem('blynkToken');
    if (enc) {
      const token = SecurityModule.decrypt(enc, SecurityModule.generateDeviceKey());
      if (token) {
        $('#blynkTokenInput').value = token;
        initBlynk(token);
      }
    } else {
      // fallback to template token (predefined)
      const fallback = 'GO_I2vtWFmQbPclq0JU7Wy5CWA9aXtsO';
      $('#blynkTokenInput').value = fallback;
      // you can automatically init with fallback if you want:
      // initBlynk(fallback);
    }
  } catch(e) { console.warn('auto token init failed', e); }
})();

// helper: append terminal lines
function appendTerminalLine(line) {
  const out = document.getElementById('terminalOutput');
  const node = document.createElement('div');
  node.textContent = `${new Date().toLocaleTimeString()} ${line}`;
  out.appendChild(node);
  out.scrollTop = out.scrollHeight;
  // also add to logs
  log(`Terminal: ${line}`);
}

// terminal send button wiring
document.addEventListener('DOMContentLoaded', () => {
  const tSend = document.getElementById('terminalSend');
  const tInput = document.getElementById('terminalInput');
  const tClear = document.getElementById('terminalClear');
  if (tSend) tSend.addEventListener('click', () => {
    const v = tInput.value.trim();
    if (!v) return;
    appendTerminalLine(`<sent> ${v}`);
    if (blynkConnected) {
      sendToBlynk('V25', v); // send typed line to V25
    } else {
      showMobileNotification('Error', 'Not connected to Blynk');
    }
    tInput.value = '';
  });
  if (tClear) tClear.addEventListener('click', () => {
    document.getElementById('terminalOutput').innerHTML = '';
  });
});

function sendBlynkNotification(title, message) {
  // For REST implementation, we can't send notifications to the device
  // But we can show them in the UI
  showPopupNotification(title, message);
}

function setBlynkProperty(pin, property, value) {
  // For REST implementation, we can't set properties
  // This is a no-op in REST mode
  console.log(`Setting property ${property} of pin ${pin} to ${value} (not supported in REST mode)`);
}

function updateBlynkLightsState() {
  state.lights.forEach((light, index) => {
    if (blynkConnected) {
      sendToBlynk(`V${index}`, light.on ? 1 : 0);
    }
  });
}

function updateBlynkModeIndicator(mode) {
  let modeValue = 0;
  switch(mode) {
    case 'teaching': modeValue = 1; break;
    case 'projector': modeValue = 2; break;
    case 'energy': modeValue = 3; break;
  }
  if (blynkConnected) {
    sendToBlynk('V20', modeValue);
  }
  const modeNames = {teaching: 'Teaching Mode', projector: 'Projector Mode', energy: 'Energy Saver'};
  // We can't set labels in REST mode, but we can log for debugging
  console.log(`Mode indicator set to ${modeNames[mode] || 'Unknown Mode'}`);
}

// When local socket (ESP) connects or disconnects, update V9 (esp status) and UI
function onEspConnected(info) {
  // In REST mode, we don't have local socket connections
  // This function is kept for compatibility but won't be called
  console.log('onEspConnected called (REST mode - no local socket)');
}

function onEspDisconnected() {
  // In REST mode, we don't have local socket connections
  // This function is kept for compatibility but won't be called
  console.log('onEspDisconnected called (REST mode - no local socket)');
}

/* ---------- Local socket code (if you ever want local connection) ---------- */
// In Blynk-only mode this is a no-op; but keep helpers so V9 updates work if you enable local socket
function useSocket(ws, host) {
  // In REST mode, we don't use local sockets
  console.log('useSocket called (REST mode - not using local socket)');
}

/* ---------- Update notification modal function override to include ESP info ---------- */
function updateNotificationModal() {
  // Update connection status
  const connectionStatusElement = document.getElementById('connectionStatusDetail');
  if (blynkConnected) {
    connectionStatusElement.textContent = 'Connected to Blynk (REST)';
    connectionStatusElement.style.color = '#4ef0a0';
  } else {
    connectionStatusElement.textContent = 'Disconnected from Blynk';
    connectionStatusElement.style.color = '#ff9a9a';
  }
  
  // ESP CARD UPDATE
  const espText = document.getElementById("espStatusText");
  const espDot = document.getElementById("espStatusDot");
  const espIp = document.getElementById("espIp");
  const espUptime = document.getElementById("espUptime");
  const espLastSeen = document.getElementById("espLastSeen");

  if (espText) {
      espText.textContent = state.espOnline ? "Online" : "Offline";
      espDot.style.background = state.espOnline ? "#4ef0a0" : "#ff6b6b";
      espIp.textContent = state.espIp || "â€”";
      espUptime.textContent = state.espUptime || "â€”";
      espLastSeen.textContent = state.espLastSeen
          ? new Date(state.espLastSeen).toLocaleString()
          : "â€”";
  }
  
  // ESP status element already updated by onEspConnected/onEspDisconnected
  document.getElementById('pirStatus').textContent = state.pir ? 'Enabled' : 'Disabled';
  document.getElementById('rcwlStatus').textContent = state.rcwl ? 'Enabled' : 'Disabled';
  document.getElementById('presenceStatus').textContent = state.presence ? 'Someone detected' : 'No one detected';
  const blynkStatusElement = document.getElementById('blynkIntegrationStatus');
  if (blynkConnected) { blynkStatusElement.textContent = 'Connected (REST)'; blynkStatusElement.style.color = '#4ef0a0'; }
  else { blynkStatusElement.textContent = 'Not connected'; blynkStatusElement.style.color = '#ff9a9a'; }
}

/* Handle presence changes with auto-off functionality */
function handlePresenceChange(presenceDetected) {
  const previousPresence = state.presence;
  state.presence = presenceDetected;
  saveState();
  
  // Update UI
  document.getElementById('presDot').classList.toggle('on', presenceDetected);
  document.getElementById('presText').textContent = presenceDetected ? 'Someone' : 'No one';
  
  // Notify user of presence change
  if (previousPresence !== presenceDetected) {
    if (presenceDetected) {
      showPopupNotification('Presence Detected', 'Motion or presence detected in the room');
    } else {
      showPopupNotification('No Presence', 'No motion or presence detected in the room');
      
      // If presence becomes false, schedule auto-off if timeout > 0
      if (state.autoOffTimeout > 0) {
        setTimeout(() => {
          // Recheck presence state to ensure it's still false
          if (!state.presence) {
            // Turn off all lights
            state.lights.forEach(l => l.on = false);
            saveState();
            renderLights();
            sendBlynkNotification('Auto-Off', 'Lights turned off due to no presence');
            updateBlynkLightsState();
            log('Auto-off: Lights turned off after timeout');
          }
        }, state.autoOffTimeout * 1000);
      }
    }
  }
  
  // Send presence status to Blynk
  if (blynkConnected) {
    sendToBlynk('V28', presenceDetected ? 1 : 0);
  }
}

/* ---------- Init & UI wiring ---------- */
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM Content Loaded â€” initializing UI and behaviors');
  initUI();
  initPageNavigation();

  // wifi button opens wifiModal
  const wifiBtn = $('#wifiBtn');
  if (wifiBtn) {
    wifiBtn.addEventListener('click', function() { addButtonAnimation('wifiBtn'); $('#wifiModal').style.display='flex'; document.body.style.overflow='hidden'; renderWifiList(); $('#autoOffTimeout').value = state.autoOffTimeout; });
  }

  const notificationBtn = $('#notificationBtn');
  if (notificationBtn) {
    notificationBtn.addEventListener('click', function() { addButtonAnimation('notificationBtn'); updateNotificationModal(); $('#notificationModal').style.display='flex'; document.body.style.overflow='hidden'; const modal = $('#notificationModal .modal'); if (modal) modal.classList.add('notification-modal-slide-down'); const notificationInterval = setInterval(updateNotificationModal, 2000); $('#notificationModal').dataset.intervalId = notificationInterval; });
  }

  const closeNotificationBtn = $('#closeNotification');
  if (closeNotificationBtn) {
    closeNotificationBtn.addEventListener('click', function() {
      addButtonAnimation('closeNotification');
      const notificationModal = $('#notificationModal');
      if (notificationModal && notificationModal.dataset.intervalId) { clearInterval(parseInt(notificationModal.dataset.intervalId)); delete notificationModal.dataset.intervalId; }
      notificationModal.style.display='none'; document.body.style.overflow=''; const modal = $('#notificationModal .modal'); if (modal) modal.classList.remove('notification-modal-slide-down');
    });
  }

  const notificationModal = $('#notificationModal');
  if (notificationModal) {
    notificationModal.addEventListener('click', (e) => {
      if (e.target === notificationModal) {
        if (notificationModal.dataset.intervalId) { clearInterval(parseInt(notificationModal.dataset.intervalId)); delete notificationModal.dataset.intervalId; }
        notificationModal.style.display='none'; document.body.style.overflow=''; const modal = $('#notificationModal .modal'); if (modal) modal.classList.remove('notification-modal-slide-down');
      }
    });
  }

  const closeWifiBtn = $('#closeWifi');
  if (closeWifiBtn) {
    closeWifiBtn.addEventListener('click', function() { addButtonAnimation('closeWifi'); $('#wifiModal').style.display='none'; document.body.style.overflow=''; });
  }

  // close wifi modal on backdrop click
  $$('.modal-back').forEach(m=> m.addEventListener('click', ev=> { if(ev.target === m){ addButtonAnimation(m.id || 'modalClose'); m.style.display='none'; document.body.style.overflow=''; } }));

  // ESC close
  document.addEventListener('keydown', e=> { if(e.key==='Escape'){ $$('.modal-back').forEach(m=> m.style.display='none'); document.body.style.overflow=''; } });

  // ensure rename & tool listeners set
  initRenameListeners(); initToolsListeners();
  
  // Set up mode modal listeners
  setupModeModal();
});



// mDNS check kept (uses local /api/wifi/status â€” harmless if not present)
async function checkMdnsResolution() {
  try {
    console.log('mDNS resolution checks disabled in Blynk-only mode');
    const protocol = window.location.protocol === 'https:' ? 'https:' : 'http:';
    const response = await fetch('/api/wifi/status', { method: 'GET', headers: { 'Content-Type': 'application/json' } });
    if (response.ok) { console.log('mDNS resolution successful'); document.getElementById('connectionStatus').textContent = 'mDNS resolution successful'; } else { console.warn('mDNS resolution failed with status:', response.status); document.getElementById('connectionStatus').textContent = `mDNS resolution failed: ${response.status}`; }
  } catch (e) {
    console.warn('mDNS resolution failed with error:', e.message);
    document.getElementById('connectionStatus').textContent = `mDNS resolution error: ${e.message}`;
    if (e.message.includes('NAME_NOT_RESOLVED')) { console.log('Suggestion: Check if the device is powered on and connected to the same network'); }
  }
}

// Initialize page navigation
function initPageNavigation() {
  const navItems = $$('.nav-item');
  navItems.forEach(item => {
    item.addEventListener('click', function() {
      const page = this.getAttribute('data-page');
      
      // Update active nav item
      navItems.forEach(nav => nav.classList.remove('active'));
      this.classList.add('active');
      
      // Show/hide pages
      $('#homePage').style.display = page === 'home' ? 'block' : 'none';
      $('#timerPage').style.display = page === 'timer' ? 'block' : 'none';
      $('#settingsPage').style.display = page === 'settings' ? 'block' : 'none';
    });
  });
}

// Initialize rename listeners
function initRenameListeners() {
  const saveRenameBtn = $('#saveRename');
  const resetNamesBtn = $('#resetNames');
  if (saveRenameBtn) {
    saveRenameBtn.addEventListener('click', function(){ addButtonAnimation('saveRename'); $$('input[data-rename]').forEach(inp=>{ const id = +inp.dataset.rename; const v = inp.value.trim(); if(v) state.lights[id].name = v; }); saveState(); renderLights(); renderRenameList(); populateTimerSelect(); log('Saved light names'); });
  }
  if (resetNamesBtn) {
    resetNamesBtn.addEventListener('click', function(){ addButtonAnimation('resetNames'); if(confirm('Reset all names and settings to defaults?')) { state = defaultState(); saveState(); initUI(); log('Reset to defaults'); } });
  }
}

/* Rename list UI (kept) */
function renderRenameList(){ const wrap = $('#renameList'); wrap.innerHTML=''; state.lights.forEach(l=>{ const row = document.createElement('div'); row.className='rename-row'; row.innerHTML = `<div style="width:28px">${l.id+1}.</div><input data-rename="${l.id}" value="${escapeHtml(l.name)}">`; wrap.appendChild(row); }); }

/* Settings tab listeners (kept) */
function initSettingsTabListeners() {
  const settingsTabs = $$('.settings-tab');
  settingsTabs.forEach(function(tab) { tab.classList.remove('active'); if (tab.dataset.tab === 'tabSensors') tab.classList.add('active'); });
  $('#tabRename').style.display = 'none'; $('#tabTools').style.display = 'none';
  settingsTabs.forEach(function(tab) {
    tab.addEventListener('click', function() {
      settingsTabs.forEach(function(t) { t.classList.remove('active'); });
      tab.classList.add('active');
      $('#tabSensors').style.display = 'none'; $('#tabRename').style.display = 'none'; $('#tabTools').style.display = 'none';
      const tabId = tab.dataset.tab;
      if (tabId === 'tabSensors') $('#tabSensors').style.display = 'block';
      else if (tabId === 'tabRename') $('#tabRename').style.display = 'block';
      else if (tabId === 'tabTools') $('#tabTools').style.display = 'block';
    });
  });
}

// Setup mode modal functionality
function setupModeModal() {
  const openSetupBtn = document.getElementById('openSetup');
  const closeModeBtn = document.getElementById('closeMode');
  const modeSaveBtn = document.getElementById('modeSaveBtn');
  
  if (openSetupBtn) {
    openSetupBtn.addEventListener('click', function() {
      addButtonAnimation('openSetup');
      openModeSelectionModal();
    });
  }
  
  if (closeModeBtn) {
    closeModeBtn.addEventListener('click', function() { 
      addButtonAnimation('closeMode'); 
      $('#modeModal').style.display='none'; 
      document.body.style.overflow=''; 
    });
  }
  
  if (modeSaveBtn) {
    modeSaveBtn.addEventListener('click', function() {
      addButtonAnimation('modeSaveBtn');
      saveModeSettings();
    });
  }
}

// Show mode selection modal (first step)
function openModeSelectionModal() {
  $('#modeModal').style.display = 'flex';
  $('#modeModalTitle').textContent = 'Select Mode to Setup';
  const grid = $('#modeModalGrid');
  grid.innerHTML = `
    <div class="mode-selection" data-mode="projector">
      <div class="mode-chip">Projector Mode</div>
    </div>
    <div class="mode-selection" data-mode="energy">
      <div class="mode-chip">Energy Saver</div>
    </div>
  `;
  $$('.mode-selection').forEach(el => {
    el.addEventListener('click', () => {
      const mode = el.dataset.mode;
      openModeModal(mode);
    });
  });
  document.body.style.overflow='hidden';
}

// Show mode modal with current settings
function openModeModal(mode){
  $('#modeModal').style.display = 'flex';
  $('#modeModalTitle').textContent = `Select lights for ${mode[0].toUpperCase()+mode.slice(1)} Mode`;
  $('#modeModal').dataset.mode = mode;
  const grid = $('#modeModalGrid'); grid.innerHTML = '';
  const arr = mode === 'projector' ? state.modeProjector : state.modeEnergy;
  state.lights.forEach((l,i)=>{
    const d = document.createElement('div'); d.className = 'mode-chip' + (arr[i] ? ' selected':'' ); d.textContent = l.name; d.dataset.i = i;
    d.addEventListener('click', ()=> d.classList.toggle('selected'));   
    grid.appendChild(d);
  });
  document.body.style.overflow='hidden';
}

// Save mode settings from modal
function saveModeSettings() {
  const mode = $('#modeModal').dataset.mode || 'projector';
  const sel = Array.from($('#modeModalGrid').querySelectorAll('.mode-chip.selected')).map(x=>+x.dataset.i);
  if(mode==='projector') state.modeProjector = state.modeProjector.map((v,i)=> sel.includes(i));
  else state.modeEnergy = state.modeEnergy.map((v,i)=> sel.includes(i));
  log(`${mode} saved`); saveState(); $('#modeModal').style.display='none'; document.body.style.overflow='';
}

// Initialize tools listeners
function initToolsListeners() {
  const refreshBtn = $('#refreshBtn'); const restartBtn = $('#restartBtn'); const clearLogsBtn = $('#clearLogsBtn'); const exportConfigBtn = $('#exportConfigBtn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', function() {
      addButtonAnimation('refreshBtn');
      if (blynkConnected) { sendToBlynk('V12', 1); showMobileNotification('Refresh', 'Device state refresh requested'); } else { showMobileNotification('Error', 'Not connected to Blynk'); }
    });
  }
  if (restartBtn) {
    restartBtn.addEventListener('click', function() {
      addButtonAnimation('restartBtn');
      if (blynkConnected) { sendToBlynk('V21', 1); showMobileNotification('Restart', 'Device restart command sent'); } else { showMobileNotification('Error', 'Not connected to Blynk'); }
    });
  }
  if (clearLogsBtn) {
    clearLogsBtn.addEventListener('click', function() { addButtonAnimation('clearLogsBtn'); state.logs = []; saveState(); renderLogs(); showMobileNotification('Logs', 'Logs cleared'); });
  }
  if (exportConfigBtn) {
    exportConfigBtn.addEventListener('click', function() { addButtonAnimation('exportConfigBtn'); const config = { lights: state.lights, pir: state.pir, rcwl: state.rcwl, pirDelay: state.pirDelay, rcwlRange: state.rcwlRange, wifiDefault: state.wifiCreds[state.wifiDefaultIndex] || null, autoOffTimeout: state.autoOffTimeout }; const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(config, null, 2)); const downloadAnchorNode = document.createElement('a'); downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", "smartlight_config.json"); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); showMobileNotification('Export', 'Configuration exported'); });
  }
  
  const connectBtn = $('#blynkConnectBtn');
  const disconnectBtn = $('#blynkDisconnectBtn');
  
  if (connectBtn) {
    connectBtn.addEventListener('click', function() {
      addButtonAnimation('blynkConnectBtn');
      const token = $('#blynkTokenInput').value.trim();
      const hardcodedToken = '4uYijCw6szawn3uskltxhM3Qr-U_Pgvg';
      const deviceKey = SecurityModule.generateDeviceKey();
      const savedHardcodedToken = localStorage.getItem('blynkHardcodedToken');
      if (savedHardcodedToken === 'true' && token !== hardcodedToken) {
        showMobileNotification('Warning', 'You are overriding the predefined Blynk token.');
        localStorage.removeItem('blynkHardcodedToken');
      }
      if (token) {
        const encryptedToken = SecurityModule.encrypt(token, deviceKey);
        localStorage.setItem('blynkToken', encryptedToken);
        if (token === hardcodedToken) {
          localStorage.setItem('blynkHardcodedToken', 'true');
        }
        initBlynk(token);
      } else {
        showMobileNotification('Error', 'Please enter a Blynk Auth Token');
      }
    });
  }
  
  if (disconnectBtn) {
    disconnectBtn.addEventListener('click', function() {
      addButtonAnimation('blynkDisconnectBtn');
      disconnectBlynk();
    });
  }
  
  // Sensor event listeners
  $('#pirToggle').addEventListener('change', e=>{ state.pir = !!e.target.checked; saveState(); log('PIR ' + (state.pir?'enabled':'disabled')); sendToBlynk('V11', state.pir?1:0); });
  $('#rcwlToggle').addEventListener('change', e=>{ state.rcwl = !!e.target.checked; saveState(); log('RCWL ' + (state.rcwl?'enabled':'disabled')); sendToBlynk('V12', state.rcwl?1:0); });
  $('#pirDelay').addEventListener('input', e=>{ state.pirDelay = parseInt(e.target.value) || 0; saveState(); });
  $('#rcwlRange').addEventListener('input', e=>{ state.rcwlRange = parseInt(e.target.value); $('#rcwlVal').textContent = state.rcwlRange + '%'; saveState(); });
  
  // Schedule buttons
  const addScheduleBtn = $('#addSchedule');
  const clearSchedulesBtn = $('#clearSchedules');
  if (addScheduleBtn) {
    addScheduleBtn.addEventListener('click', function() {
      addButtonAnimation('addSchedule');
      const s = $('#schStart').value, e = $('#schEnd').value, sc = $('#schScene').value;
      if (!s || !e) { showMobileNotification('Error','Pick start and end'); return; }
      state.schedules.push({start:s,end:e,scene:sc}); saveState(); renderSchedules(); log('Schedule added '+s+'-'+e+' '+sc);
    });
  }
  if (clearSchedulesBtn) {
    clearSchedulesBtn.addEventListener('click', function() { addButtonAnimation('clearSchedules'); showMobileNotification('Confirm', 'Schedules cleared'); state.schedules=[]; saveState(); renderSchedules(); log('Schedules cleared'); });
  }
  
  // Timer buttons
  const addTimerBtn = $('#addTimer');
  const clearTimersBtn = $('#clearTimers');
  if (addTimerBtn) {
    addTimerBtn.addEventListener('click', function() {
      addButtonAnimation('addTimer');
      const h = Math.max(0, parseInt($('#tHours').value||0)), m = Math.max(0, parseInt($('#tMinutes').value||0)), s = Math.max(0, parseInt($('#tSeconds').value||0)), lid = parseInt($('#tLight').value||0);
      if (h===0 && m===0 && s===0) { showMobileNotification('Error','Set duration'); return; }
      const name = state.lights[lid].name;
      state.timers.push({name,h,m,s,light:lid,created:Date.now()}); saveState(); renderTimers(); log(`Timer set: ${name} ${h}h ${m}m ${s}s`);
    });
  }
  if (clearTimersBtn) {
    clearTimersBtn.addEventListener('click', function() { addButtonAnimation('clearTimers'); showMobileNotification('Confirm', 'Timers cleared'); state.timers=[]; saveState(); renderTimers(); log('Cleared timers'); });
  }
}

// Helper function to add button animation
function addButtonAnimation(buttonId) {
  const button = $('#' + buttonId);
  if (button) {
    button.classList.add('pressed');
    setTimeout(() => {
      button.classList.remove('pressed');
    }, 600);
  }
}

// Kickoff
window.addEventListener('DOMContentLoaded', function() {
  const logo = document.querySelector('.mark-css');
  if (logo) { setTimeout(() => { const elements = logo.querySelectorAll('.logo-circle, .logo-inner, .logo-wave'); elements.forEach(el => { el.style.opacity = '1'; }); }, 100); }
});

// UI HEARTBEAT â†’ Notifies Blynk UI is active
setInterval(() => {
    if (blynkConnected) {
        sendToBlynk("V8", 1);  // UI HEARTBEAT â†’ V8
    }
}, 8000);

// When closing page, send UI OFFLINE
window.addEventListener("beforeunload", () => {
    if (blynkConnected) sendToBlynk("V8", 0);  // UI heartbeat OFF
});

/* ---------- Close tags ---------- */
</script>
</body>
</html>
